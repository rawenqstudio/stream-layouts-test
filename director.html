<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>RE≈ªYSERKA</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { font-family: sans-serif; background: #333; color: white; text-align: center; padding: 20px; }
        .container { max-width: 600px; margin: 0 auto; }
        
        button { cursor: pointer; border: none; border-radius: 5px; color: white; transition: 0.2s; }
        .btn-layout { background: #007bff; width: 45%; padding: 12px; font-size: 14px; margin: 5px; }
        .btn-layout:hover { background: #0056b3; }
        .btn-tool { width: 93%; padding: 10px; margin: 5px auto; display: block; font-weight: bold; }
        .btn-refresh-all { background: #ff9800; } .btn-refresh-all:hover { background: #e68900; }
        .btn-sync { background: #6610f2; } .btn-sync:hover { background: #520dc2; } 
        .btn-toggle-off { background: #17a2b8; } .btn-toggle-off:hover { background: #117a8b; }
        .btn-toggle-on { background: #28a745; }
        .btn-toggle-game { background: #e91e63; margin-top: 30px; } .btn-toggle-game:hover { background: #c2185b; }
        
        .status { margin-top: 10px; color: #aaa; font-weight: bold;}
        .controls { display: none; margin-top: 30px; border-top: 1px solid #555; padding-top: 20px;}
        input { display: none; }

        #guest-list { margin-top: 20px; text-align: left; background: #222; padding: 20px; border-radius: 10px; }
        .guest-item { display: flex; justify-content: space-between; align-items: center; background: #444; padding: 10px; margin-bottom: 10px; border-radius: 5px; flex-wrap: wrap; }
        .guest-info { display: flex; flex-direction: column; flex-grow: 1; }
        .guest-name { font-size: 1.2em; font-weight: bold; }
        .guest-stats { font-size: 0.75em; color: #aaa; margin-top: 4px; font-family: monospace; }
        .stat-good { color: #00ff00; } .stat-mid { color: #ffcc00; } .stat-bad { color: #ff4444; font-weight: bold; }
        .guest-actions { display: flex; gap: 5px; }
        .btn-icon { width: 40px; height: 40px; padding: 0; display: flex; align-items: center; justify-content: center; font-size: 20px; }
        .mic-on { background: #28a745; } .mic-off { background: #dc3545; }
        .btn-refresh { background: #ff9800; } .btn-refresh:hover { background: #e68900; }
        .btn-mirror { background: #6c757d; } .btn-mirror:hover { background: #5a6268; }
        .mirror-on { background: #007bff; border: 2px solid white; }
        .btn-move { background: #343a40; font-size: 14px; } .btn-move:hover { background: #495057; }

        /* --- STYL MENU GIER --- */
        .game-section { background: #2a2a2a; padding: 15px; border-radius: 10px; margin-top: 10px; border: 1px solid #444; display: none; }
        
        /* Menu Wyboru */
        .game-menu-grid { display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; }
        .game-tile { width: 45%; padding: 20px; background: #444; border-radius: 8px; cursor: pointer; transition: 0.2s; font-weight: bold; }
        .game-tile:hover { background: #555; transform: scale(1.05); }
        .game-tile-active { background: #e91e63; }

        /* Widok Konkretnej Gry */
        #game-heads-up { display: none; } /* Domy≈õlnie ukryte */
        .game-select { width: 100%; padding: 10px; background: #444; color: white; border: none; border-radius: 5px; font-size: 16px; margin-bottom: 10px; }
        .btn-game-back { background: #666; width: 100%; padding: 8px; margin-bottom: 15px; }
        .btn-game-start { background: #e91e63; width: 48%; display: inline-block; padding: 12px; font-weight: bold; }
        .btn-game-clear { background: #555; width: 48%; display: inline-block; padding: 12px; font-weight: bold; }
        
        /* Lista Graczy w Grze */
        #game-players-list { margin-top: 15px; text-align: left; }
        .game-player-row { display: flex; align-items: center; gap: 5px; margin-bottom: 5px; background: #333; padding: 8px; border-radius: 5px; }
        .game-player-name { width: 100px; font-weight: bold; font-size: 0.9em; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .game-input { background: #111; border: 1px solid #555; color: #fff; padding: 8px; flex-grow: 1; border-radius: 3px; font-size: 14px; }
        .btn-mini { padding: 8px 12px; font-size: 14px; width: auto; }
        .btn-reroll { background: #9c27b0; } .btn-reroll:hover { background: #7b1fa2; }
        .btn-send { background: #009688; } .btn-send:hover { background: #00796b; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Panel Re≈ºysera</h1>
        <div class="status" id="status-msg">Inicjalizacja...</div>
        <input type="text" id="target-id">

        <div class="controls" id="control-panel">
            <!-- UK≈ÅADY I NARZƒòDZIA (BEZ ZMIAN) -->
            <h2>üé• Uk≈Çad kamer:</h2>
            <div style="margin-bottom: 15px; border-bottom: 1px solid #555; padding-bottom: 10px;">
                <button class="btn-layout" onclick="sendLayout('layout-grid')" style="width: 90%; background: #6f42c1;">üî≥ Pe≈Çna Siatka (Grid)</button>
            </div>
            <div style="display: flex; justify-content: center; flex-wrap: wrap; gap: 5px;">
                <button class="btn-layout" onclick="sendLayout('layout-top')">‚¨ÜÔ∏è G√≥ra</button>
                <button class="btn-layout" onclick="sendLayout('layout-bottom')">‚¨áÔ∏è D√≥≈Ç</button>
                <button class="btn-layout" onclick="sendLayout('layout-sidebar-left')">‚¨ÖÔ∏è Lewo</button>
                <button class="btn-layout" onclick="sendLayout('layout-sidebar-right')">‚û°Ô∏è Prawo</button>
            </div>
            <div style="margin-top: 10px;">
                <button class="btn-layout" onclick="sendLayout('layout-split')" style="width: 90%; background: #e83e8c;">‚ÜîÔ∏è Obie Strony (Split)</button>
            </div>
            <div style="margin-top: 5px;">
                <button class="btn-layout" onclick="sendLayout('layout-center-stage')" style="width: 90%; background: #6610f2;">‚≠êÔ∏è Center Stage</button>
            </div>

            <h2 style="margin-top: 30px;">‚öôÔ∏è Narzƒôdzia:</h2>
            <button class="btn-tool btn-toggle-off" id="btn-labels" onclick="toggleLabels()">üî§ Podpisy: UKRYTE</button>
            <button class="btn-tool btn-toggle-off" id="btn-icons" onclick="toggleIcons()">üîá Ikony Mute: UKRYTE</button>
            <button class="btn-tool btn-refresh-all" onclick="refreshCam('all')" style="margin-top: 20px;">üîÑ Od≈õwie≈º Bufory (Fix Lag)</button>
            <button class="btn-tool btn-sync" onclick="syncGuestsWithOBS()">üì° Wymu≈õ po≈ÇƒÖczenie z nowym OBS</button>
            
            <!-- PRZYCISK POKA≈ª/UKRYJ PANEL GIER -->
            <button class="btn-tool btn-toggle-game" onclick="toggleGamePanel()">üéÆ Poka≈º Panel Gier</button>

            <!-- G≈Å√ìWNY KONTENER GIER -->
            <div id="game-section" class="game-section">
                
                <!-- 1. MENU WYBORU GRY -->
                <div id="game-menu">
                    <h3>Wybierz Grƒô:</h3>
                    <div class="game-menu-grid">
                        <div class="game-tile game-tile-active" onclick="openGame('heads-up')">
                            üé≤ Cz√≥≈Çko<br><span style="font-size:0.8em; font-weight:normal;">Has≈Ça na czo≈Ço</span>
                        </div>
                        <div class="game-tile" style="opacity: 0.5; cursor: not-allowed;">
                            üöß Kalambury<br><span style="font-size:0.8em; font-weight:normal;">(Wkr√≥tce)</span>
                        </div>
                    </div>
                </div>

                <!-- 2. WIDOK GRY: CZ√ì≈ÅKO -->
                <div id="game-heads-up">
                    <button class="btn-game-back" onclick="closeGame()">‚¨Ö Wr√≥ƒá do menu gier</button>
                    
                    <h3 style="margin-top:0">Gra: Cz√≥≈Çko</h3>
                    <select id="game-category" class="game-select">
                        <option value="Zwierzƒôta">üê∂ Zwierzƒôta</option>
                        <option value="Filmy">üé¨ Filmy</option>
                        <option value="Postacie">ü¶∏ Postacie Fikcyjne</option>
                        <option value="Zawody">üë∑ Zawody</option>
                        <option value="Przedmioty">üì¶ Przedmioty</option>
                    </select>
                    
                    <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                        <button class="btn-game-clear" onclick="clearGame()">üóëÔ∏è Wyczy≈õƒá Wszystkich</button>
                        <button class="btn-game-start" onclick="dealCards()">üé≤ Rozdaj Wszystkim</button>
                    </div>
                    
                    <hr style="border: 0; border-top: 1px solid #444; margin: 10px 0;">
                    
                    <!-- Lista graczy do rƒôcznego sterowania -->
                    <div id="game-players-list"></div>
                </div>

            </div>
            
            <h2>üé§ ZarzƒÖdzanie Go≈õƒámi:</h2>
            <div id="guest-list">
                <p style="text-align:center; color:#777;">Oczekiwanie na go≈õci...</p>
            </div>
            <p style="color: #555; font-size: 0.8em; margin-top: 10px;">Easter Egg: Ctrl + Shift + F</p>
        </div>
    </div>

    <script>
        // BAZA DANYCH
        const gameData = {
            "Zwierzƒôta": ["S≈Ço≈Ñ", "≈ªyrafa", "Chomik", "Pingwin", "Rekin", "WƒÖ≈º", "Orze≈Ç", "Biedronka", "Krowa", "Kangur", "Zebra", "Lew", "≈öwinka", "Pies", "Kot", "Papuga", "Krokodyl", "Ma≈Çpa", "Nied≈∫wied≈∫", "≈ªaba"],
            "Filmy": ["Titanic", "Shrek", "Matrix", "Harry Potter", "Gwiezdne Wojny", "Kr√≥l Lew", "W≈Çadca Pier≈õcieni", "Joker", "Avengers", "Batman", "Spider-Man", "Forrest Gump", "Kraina Lodu", "Minionki", "Piraci z Karaib√≥w"],
            "Postacie": ["Myszka Miki", "Superman", "≈öwiƒôty Miko≈Çaj", "Sherlock Holmes", "Mario", "Pikachu", "Vader", "Wied≈∫min", "Shrek", "Barbie", "SpongeBob", "Hulk", "Iron Man", "Tarzan", "Zorro"],
            "Zawody": ["Stra≈ºak", "Policjant", "Lekarz", "Nauczyciel", "Kucharz", "Kierowca", "Pilot", "Astronauta", "Hydraulik", "Fryzjer", "Aktor", "Piosenkarz", "Malarz", "Rolnik", "Programista"],
            "Przedmioty": ["Krzes≈Ço", "Telefon", "Samoch√≥d", "D≈Çugopis", "Butelka", "KsiƒÖ≈ºka", "Komputer", "Zegarek", "Lustro", "Klucz", "M≈Çotek", "Szczoteczka", "Widelec", "Okulary", "Poduszka"]
        };

        // ... (Zmienne PeerJS bez zmian) ...
        const urlParams = new URLSearchParams(window.location.search);
        const useStunOnly = urlParams.get('stunonly');
        const isMulti = urlParams.get('multi');
        const roomID = urlParams.get('room');

        const selectedConfig = useStunOnly ? [ { urls: "stun:stun.l.google.com:19302" } ] : [
            { urls: "stun:stun.l.google.com:19302" },
            { urls: "turn:openrelay.metered.ca:80?transport=udp", username: "openrelayproject", credential: "openrelayproject" },
            { urls: "turn:openrelay.metered.ca:443?transport=tcp", username: "openrelayproject", credential: "openrelayproject" }
        ];

        const peer = new Peer(isMulti ? roomID : undefined, { config: { iceServers: selectedConfig } });
        let conn = null; 
        const obsClients = []; 
        const guestConnections = []; 
        const multiGuestsState = {}; 
        let guestOrder = []; 
        let labelsVisible = false;
        let iconsVisible = false;
        
        // Stan Gry
        const currentWords = {};

        // --- NAWIGACJA PO PANELU GIER ---
        function toggleGamePanel() {
            const panel = document.getElementById('game-section');
            if (panel.style.display === 'block') {
                panel.style.display = 'none';
            } else {
                panel.style.display = 'block';
                // Domy≈õlnie poka≈º menu
                document.getElementById('game-menu').style.display = 'block';
                document.getElementById('game-heads-up').style.display = 'none';
            }
        }

        function openGame(gameId) {
            document.getElementById('game-menu').style.display = 'none';
            document.getElementById('game-heads-up').style.display = 'block';
            // Od razu renderuj kontrolki, nawet jak nie ma hase≈Ç
            renderGameControls();
        }

        function closeGame() {
            document.getElementById('game-heads-up').style.display = 'none';
            document.getElementById('game-menu').style.display = 'block';
        }

        // --- LOGIKA GRY: CZ√ì≈ÅKO ---
        
        // 1. Rozdaj wszystkim
        function dealCards() {
            const category = document.getElementById('game-category').value;
            const words = [...gameData[category]];
            let guestIds = isMulti ? Object.keys(multiGuestsState) : guestOrder;

            if(guestIds.length === 0) {
                alert("Brak go≈õci do rozdania kart!");
                return;
            }

            guestIds.forEach(id => {
                if (words.length === 0) words.push(...gameData[category]);
                const randomIndex = Math.floor(Math.random() * words.length);
                const word = words[randomIndex];
                words.splice(randomIndex, 1);
                
                currentWords[id] = word;
            });

            console.log("Rozdano karty:", currentWords);
            broadcastCommand({ type: 'game-deal', cards: currentWords });
            renderGameControls(); 
        }

        // 2. Wyczy≈õƒá
        function clearGame() {
            for (let id in currentWords) delete currentWords[id];
            broadcastCommand({ type: 'game-clear' });
            renderGameControls();
        }

        // 3. Rƒôczna zmiana has≈Ça (Update)
        function updateGuestWord(id) {
            const input = document.getElementById(`word-input-${id}`);
            const newWord = input.value;
            
            // Zapisz
            currentWords[id] = newWord;
            
            // Wy≈õlij do OBS
            broadcastCommand({ type: 'game-update-card', targetId: id, word: newWord });
            
            // Wizualne potwierdzenie (migniƒôcie)
            input.style.borderColor = "#00ff00";
            setTimeout(() => input.style.borderColor = "#555", 500);
        }

        // 4. Losuj pojedynczo
        function rerollGuest(id) {
            const category = document.getElementById('game-category').value;
            const words = gameData[category];
            const randomWord = words[Math.floor(Math.random() * words.length)];
            
            const input = document.getElementById(`word-input-${id}`);
            if(input) input.value = randomWord;
            
            updateGuestWord(id); // Wywo≈Çaj funkcjƒô aktualizacji z nowƒÖ warto≈õciƒÖ inputa
        }

        // 5. Renderowanie listy w panelu gry
        function renderGameControls() {
            const container = document.getElementById('game-players-list');
            container.innerHTML = "";
            
            let guestIds = isMulti ? Object.keys(multiGuestsState) : guestOrder;
            
            if(guestIds.length === 0) {
                container.innerHTML = "<p style='color:#777; font-size:0.9em;'>Brak go≈õci. Zapro≈õ kogo≈õ, aby graƒá.</p>";
                return;
            }

            guestIds.forEach(id => {
                const name = (multiGuestsState[id]) ? multiGuestsState[id].name : "Go≈õƒá";
                const currentWord = currentWords[id] || "";

                const row = document.createElement('div');
                row.className = 'game-player-row';
                row.innerHTML = `
                    <div class="game-player-name" title="${name}">${name}</div>
                    <input type="text" id="word-input-${id}" class="game-input" value="${currentWord}" placeholder="Wpisz has≈Ço...">
                    <button class="btn-mini btn-reroll" onclick="rerollGuest('${id}')" title="Wylosuj nowe">üé≤</button>
                    <button class="btn-mini btn-send" onclick="updateGuestWord('${id}')" title="Wy≈õlij do OBS">‚úÖ</button>
                `;
                container.appendChild(row);
            });
        }

        // ... [RESZTA KODU BEZ ZMIAN: window.onload, connectToOBS, handleData itp.] ...
        // SKOPIUJ PONI≈ªSZY BLOK DOK≈ÅADNIE TAK JAK BY≈Å, JEST NIEZBƒòDNY
        
        window.onload = function() {
            if(!roomID) { document.getElementById('status-msg').innerText = "B≈ÅƒÑD: Brak ID w linku."; return; }
            document.getElementById('target-id').value = roomID;
            if (isMulti) {
                document.getElementById('status-msg').innerText = "üì° Tryb Multi: SERWER AKTYWNY";
                document.getElementById('control-panel').style.display = "block";
                peer.on('connection', handleIncomingConnection);
            } else {
                document.getElementById('status-msg').innerText = "Szukam OBS...";
                setTimeout(connectToOBS, 1000);
            }
        }
        document.addEventListener('keydown', (e) => { if (e.ctrlKey && e.shiftKey && (e.key === 'F' || e.key === 'f')) addFakeGuest(); });
        function addFakeGuest() {
            const fakeId = 'fake-' + Math.floor(Math.random() * 10000);
            const fakeNames = ["Sztuczny Jan", "Testowa Anna", "Bot Marek", "Demo Zosia"];
            const randomName = fakeNames[Math.floor(Math.random() * fakeNames.length)];
            const randomImg = `https://picsum.photos/seed/${fakeId}/640/360`;
            broadcastCommand({ type: 'add-fake-guest', id: fakeId, name: randomName, img: randomImg });
            multiGuestsState[fakeId] = { id: fakeId, name: randomName, muted: false, mirrored: false, conn: null };
            if (!guestOrder.includes(fakeId)) guestOrder.push(fakeId);
            refreshMultiModeUI(); renderGameControls();
        }
        function connectToOBS() {
            const targetId = document.getElementById('target-id').value;
            conn = peer.connect(targetId);
            conn.on('open', () => {
                document.getElementById('status-msg').innerText = "‚úÖ PO≈ÅƒÑCZONO Z OBS (Standard)";
                document.getElementById('status-msg').style.color = "#00ff00";
                document.getElementById('control-panel').style.display = "block";
                conn.send({ type: 'director-hello' });
            });
            conn.on('data', (data) => handleData(data));
            conn.on('error', (err) => alert("B≈ÇƒÖd: " + err));
        }
        function handleIncomingConnection(connection) {
            connection.on('open', () => console.log("Po≈ÇƒÖczenie:", connection.peer));
            connection.on('data', (data) => {
                if (data.type === 'register-obs') {
                    obsClients.push(connection);
                    updateStatusMsg();
                    connection.send({ type: 'toggle-labels', show: labelsVisible });
                    connection.send({ type: 'toggle-icons', show: iconsVisible });
                    connection.send({ type: 'layout', mode: 'layout-grid' });
                    if(guestOrder.length > 0) connection.send({ type: 'reorder-guests', order: guestOrder });
                }
                if (data.type === 'get-obs-list') {
                    if(!guestConnections.includes(connection)) guestConnections.push(connection);
                    const obsIds = obsClients.map(c => c.peer);
                    connection.send({ type: 'obs-list', targets: obsIds });
                }
                handleData(data, connection);
            });
            connection.on('close', () => {
                let idx = obsClients.indexOf(connection);
                if (idx > -1) obsClients.splice(idx, 1);
                idx = guestConnections.indexOf(connection);
                if (idx > -1) guestConnections.splice(idx, 1);
                if (multiGuestsState[connection.peer]) {
                    delete multiGuestsState[connection.peer];
                    guestOrder = guestOrder.filter(id => id !== connection.peer);
                    refreshMultiModeUI(); renderGameControls();
                }
                updateStatusMsg();
            });
        }
        function updateStatusMsg() {
            document.getElementById('status-msg').innerText = `‚úÖ OBS: ${obsClients.length} | Go≈õci: ${guestConnections.length}`;
            document.getElementById('status-msg').style.color = "#00ff00";
        }
        function handleData(data, sourceConn) {
            if(data.type === 'guest-list' && !isMulti) {
                data.list.forEach(g => { multiGuestsState[g.id] = g; if(!guestOrder.includes(g.id)) guestOrder.push(g.id); });
                const newIds = data.list.map(g => g.id);
                guestOrder = guestOrder.filter(id => newIds.includes(id));
                refreshMultiModeUI(); renderGameControls();
            }
            if(data.type === 'stats-update') updateStats(data.stats);
            if (isMulti) {
                if(data.type === 'identify' && sourceConn) {
                    if(!guestConnections.includes(sourceConn)) guestConnections.push(sourceConn);
                    multiGuestsState[sourceConn.peer] = { id: sourceConn.peer, name: data.name || "Go≈õƒá", muted: false, mirrored: false, conn: sourceConn };
                    if (!guestOrder.includes(sourceConn.peer)) guestOrder.push(sourceConn.peer);
                    refreshMultiModeUI(); renderGameControls(); updateStatusMsg();
                }
                if(data.type === 'mic-status' && sourceConn) {
                    if (multiGuestsState[sourceConn.peer]) {
                        multiGuestsState[sourceConn.peer].muted = data.muted;
                        refreshMultiModeUI(); 
                        obsClients.forEach(c => { if(c.open) c.send({ type: 'mic-status', peer: sourceConn.peer, muted: data.muted }); });
                    }
                }
            }
        }
        function refreshMultiModeUI() {
            const sortedList = [];
            guestOrder.forEach(id => { if(multiGuestsState[id]) sortedList.push(multiGuestsState[id]); });
            renderGuestList(sortedList);
        }
        function moveGuest(id, direction) {
            const index = guestOrder.indexOf(id);
            if (index === -1) return;
            if (direction === 'up' && index > 0) { [guestOrder[index], guestOrder[index - 1]] = [guestOrder[index - 1], guestOrder[index]]; } 
            else if (direction === 'down' && index < guestOrder.length - 1) { [guestOrder[index], guestOrder[index + 1]] = [guestOrder[index + 1], guestOrder[index]]; } 
            else { return; }
            refreshMultiModeUI(); renderGameControls(); broadcastCommand({ type: 'reorder-guests', order: guestOrder });
        }
        function broadcastCommand(cmd) {
            if (isMulti) obsClients.forEach(c => { if(c.open) c.send(cmd); });
            else if (conn && conn.open) conn.send(cmd);
        }
        function syncGuestsWithOBS() {
            if (!isMulti) { alert("Tylko Multi!"); return; }
            const btn = document.querySelector('.btn-sync');
            btn.innerText = "‚è≥ Synchronizacja...";
            guestConnections.forEach(g => { if (g.open) g.send({ type: 'force-sync' }); });
            setTimeout(() => { btn.innerText = "üì° Wymu≈õ po≈ÇƒÖczenie z nowym OBS"; }, 1000);
        }
        function sendLayout(layoutName) { broadcastCommand({ type: 'layout', mode: layoutName }); }
        function toggleGuestMic(id, currentMutedState) {
            if (isMulti) {
                const guest = multiGuestsState[id];
                if (id.startsWith('fake-')) {
                    guest.muted = !currentMutedState; refreshMultiModeUI();
                    broadcastCommand({ type: 'remote-mute', targetId: id, state: guest.muted }); return;
                }
                if (guest && guest.conn && guest.conn.open) guest.conn.send({ type: 'mute-cmd', state: !currentMutedState });
            } else { broadcastCommand({ type: 'remote-mute', targetId: id, state: !currentMutedState }); }
        }
        function refreshCam(id) { broadcastCommand({ type: 'refresh-cam', targetId: id }); }
        function toggleMirror(id) {
            if (isMulti && multiGuestsState[id]) { multiGuestsState[id].mirrored = !multiGuestsState[id].mirrored; refreshMultiModeUI(); }
            broadcastCommand({ type: 'toggle-mirror', targetId: id });
        }
        function toggleLabels() {
            labelsVisible = !labelsVisible;
            broadcastCommand({ type: 'toggle-labels', show: labelsVisible });
            updateToolBtn('btn-labels', labelsVisible, "üî§ Podpisy");
        }
        function toggleIcons() {
            iconsVisible = !iconsVisible;
            broadcastCommand({ type: 'toggle-icons', show: iconsVisible });
            updateToolBtn('btn-icons', iconsVisible, "üîá Ikony Mute");
        }
        function updateToolBtn(id, state, text) {
            const btn = document.getElementById(id);
            btn.innerText = state ? `${text}: WIDOCZNE` : `${text}: UKRYTE`;
            btn.className = state ? "btn-tool btn-toggle-on" : "btn-tool btn-toggle-off";
        }
        function renderGuestList(list) {
            const container = document.getElementById('guest-list');
            container.innerHTML = "";
            if(list.length === 0) { container.innerHTML = '<p style="text-align:center; color:#777;">Brak go≈õci online.</p>'; return; }
            list.forEach((guest, index) => {
                const item = document.createElement('div');
                item.className = 'guest-item';
                const micClass = guest.muted ? 'mic-off' : 'mic-on';
                const micIcon = guest.muted ? 'üîá' : 'üé§';
                const statusText = guest.muted ? '(Wyciszony)' : '';
                const mirrorClass = guest.mirrored ? 'mirror-on' : 'mirror-off';
                const upVisibility = index === 0 ? 'visibility:hidden' : '';
                const downVisibility = index === list.length - 1 ? 'visibility:hidden' : '';
                item.innerHTML = `
                    <div class="guest-actions" style="margin-right: 10px;">
                        <button class="btn-icon btn-move" onclick="moveGuest('${guest.id}', 'up')" style="${upVisibility}">‚¨ÜÔ∏è</button>
                        <button class="btn-icon btn-move" onclick="moveGuest('${guest.id}', 'down')" style="${downVisibility}">‚¨áÔ∏è</button>
                    </div>
                    <div class="guest-info">
                        <span class="guest-name">${guest.name} <small style="font-weight:normal; font-size:0.7em">${statusText}</small></span>
                        <span id="stats-${guest.id}" class="guest-stats">${guest.id.startsWith('fake-') ? 'SZTUCZNY GO≈öƒÜ' : 'Czekam na dane...'}</span>
                    </div>
                    <div class="guest-actions">
                        <button class="btn-icon ${mirrorClass}" onclick="toggleMirror('${guest.id}')" title="Lustrzane odbicie">ü™û</button>
                        <button class="btn-icon btn-refresh" onclick="refreshCam('${guest.id}')" title="Od≈õwie≈º">üîÑ</button>
                        <button class="btn-icon btn-mic ${micClass}" onclick="toggleGuestMic('${guest.id}', ${guest.muted})" title="Wycisz/Odcisz">${micIcon}</button>
                    </div>
                `;
                container.appendChild(item);
            });
        }
        function updateStats(stats) {
            for (const [id, data] of Object.entries(stats)) {
                const el = document.getElementById(`stats-${id}`);
                if (el) {
                    let colorClass = 'stat-good';
                    if (data.bitrate < 1000 || data.packetLoss > 5) colorClass = 'stat-mid';
                    if (data.bitrate < 300 || data.packetLoss > 15) colorClass = 'stat-bad';
                    el.innerHTML = `Bitrate: <span class="${colorClass}">${data.bitrate} kbps</span> | Loss: <span class="${colorClass}">${data.packetLoss}</span> | Res: ${data.resolution}`;
                }
            }
        }
    </script>
</body>
</html>